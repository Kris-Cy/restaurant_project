{% extends "base.html" %}

{% block title %}Dish Price Calculator{% endblock %}



{% block content %}
<!-- Add Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Fallback if the first CDN fails
    if (typeof Chart === 'undefined') {
        console.log('Trying fallback CDN...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';
        script.onload = function() {
            console.log('Chart.js loaded from fallback CDN');
            if (typeof updateAllCalculations === 'function') {
                updateAllCalculations();
            }
        };
        script.onerror = function() {
            console.error('Failed to load Chart.js from both CDNs');
        };
        document.head.appendChild(script);
    } else {
        console.log('Chart.js loaded successfully from primary CDN');
    }
</script>

<h1 class="page-title">Dish Price Calculator</h1>
<p>Calculate the optimal pricing for your restaurant dishes based on ingredient costs and desired profit margins.</p>

<div style="display: flex; gap: 20px; margin-top: 30px;">
    <!-- Left Section: Ingredient Management -->
    <div class="points-section" style="flex: 1;">
        <h3 class="points-title">Ingredient Management</h3>
        <div id="ingredients-container">
            <div class="ingredient-row" data-index="0">
                <span class="ingredient-label">Ingredient 1:</span>
                <div class="ingredient-fields">
                    <div class="ingredient-field">
                        <label>Name</label>
                        <input type="text" class="ingredient-name" placeholder="Ingredient Name" value="Beef">
                    </div>
                    <div class="ingredient-field">
                        <label>Cost ($)</label>
                        <input type="number" class="ingredient-cost" placeholder="Cost ($)" value="15.99" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Amount</label>
                        <input type="number" class="ingredient-amount" placeholder="Amount" value="0.4" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Unit</label>
                        <select class="ingredient-unit" onchange="updateAllCalculations()">
                            <option value="lbs">lbs</option>
                            <option value="oz">oz</option>
                            <option value="g">g</option>
                            <option value="cups">cups</option>
                            <option value="tbsp">tbsp</option>
                            <option value="tsp">tsp</option>
                            <option value="each">each</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeIngredient(0)" style="margin-left: 5px; align-self: flex-end;">×</button>
                </div>
            </div>
            <div class="ingredient-row" data-index="1">
                <span class="ingredient-label">Ingredient 2:</span>
                <div class="ingredient-fields">
                    <div class="ingredient-field">
                        <label>Name</label>
                        <input type="text" class="ingredient-name" placeholder="Ingredient Name" value="Noodles">
                    </div>
                    <div class="ingredient-field">
                        <label>Cost ($)</label>
                        <input type="number" class="ingredient-cost" placeholder="Cost ($)" value="2.49" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Amount</label>
                        <input type="number" class="ingredient-amount" placeholder="Amount" value="0.3" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Unit</label>
                        <select class="ingredient-unit" onchange="updateAllCalculations()">
                            <option value="lbs">lbs</option>
                            <option value="oz">oz</option>
                            <option value="g">g</option>
                            <option value="cups">cups</option>
                            <option value="tbsp">tbsp</option>
                            <option value="tsp">tsp</option>
                            <option value="each">each</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeIngredient(1)" style="margin-left: 5px; align-self: flex-end;">×</button>
                </div>
            </div>
            <div class="ingredient-row" data-index="2">
                <span class="ingredient-label">Ingredient 3:</span>
                <div class="ingredient-fields">
                    <div class="ingredient-field">
                        <label>Name</label>
                        <input type="text" class="ingredient-name" placeholder="Ingredient Name" value="Vegetables">
                    </div>
                    <div class="ingredient-field">
                        <label>Cost ($)</label>
                        <input type="number" class="ingredient-cost" placeholder="Cost ($)" value="3.99" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Amount</label>
                        <input type="number" class="ingredient-amount" placeholder="Amount" value="0.2" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Unit</label>
                        <select class="ingredient-unit" onchange="updateAllCalculations()">
                            <option value="lbs">lbs</option>
                            <option value="oz">oz</option>
                            <option value="g">g</option>
                            <option value="cups">cups</option>
                            <option value="tbsp">tbsp</option>
                            <option value="tsp">tsp</option>
                            <option value="each">each</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeIngredient(2)" style="margin-left: 5px; align-self: flex-end;">×</button>
                </div>
            </div>
        </div>
        <button class="btn btn-success" onclick="addIngredient()">+ Add Ingredient</button>
        
        <!-- Dish Information -->
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-top: 0;">Dish Information</h4>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <label style="min-width: 120px;">Dish Name:</label>
                <input type="text" id="dish-name" value="Beef Stir-Fry" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <label style="min-width: 120px;">Labor Cost ($):</label>
                <input type="number" id="labor-cost" value="4.25" step="0.01" onchange="updateAllCalculations()" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="min-width: 120px;">Overhead Cost ($):</label>
                <input type="number" id="overhead-cost" value="2.15" step="0.01" onchange="updateAllCalculations()" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <!-- Sales Data Input -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Sales Data Analysis</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Add historical sales data to find the optimal price point</p>
            
            <div id="sales-data-container">
                <div class="sales-row" data-index="0">
                    <span class="sales-label">Price Point 1:</span>
                    <div class="sales-fields">
                        <div class="sales-field">
                            <label>Price ($)</label>
                            <input type="number" class="sales-price" placeholder="Price" value="14.00" step="0.01" onchange="updateSalesChart()">
                        </div>
                        <div class="sales-field">
                            <label>Sales</label>
                            <input type="number" class="sales-quantity" placeholder="Quantity" value="28" step="1" onchange="updateSalesChart()">
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeSalesData(0)" style="margin-left: 5px; align-self: flex-end;">×</button>
                    </div>
                </div>
                <div class="sales-row" data-index="1">
                    <span class="sales-label">Price Point 2:</span>
                    <div class="sales-fields">
                        <div class="sales-field">
                            <label>Price ($)</label>
                            <input type="number" class="sales-price" placeholder="Price" value="16.00" step="0.01" onchange="updateSalesChart()">
                        </div>
                        <div class="sales-field">
                            <label>Sales</label>
                            <input type="number" class="sales-quantity" placeholder="Quantity" value="22" step="1" onchange="updateSalesChart()">
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeSalesData(1)" style="margin-left: 5px; align-self: flex-end;">×</button>
                    </div>
                </div>
                <div class="sales-row" data-index="2">
                    <span class="sales-label">Price Point 3:</span>
                    <div class="sales-fields">
                        <div class="sales-field">
                            <label>Price ($)</label>
                            <input type="number" class="sales-price" placeholder="Price" value="18.00" step="0.01" onchange="updateSalesChart()">
                        </div>
                        <div class="sales-field">
                            <label>Sales</label>
                            <input type="number" class="sales-quantity" placeholder="Quantity" value="15" step="1" onchange="updateSalesChart()">
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeSalesData(2)" style="margin-left: 5px; align-self: flex-end;">×</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-success" onclick="addSalesData()">+ Add Sales Data</button>
        </div>
        
        <!-- Dish Management Buttons -->
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="margin-top: 0; color: #333;">Dish Management</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Save your current dish configuration or load a previously saved dish</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveDish()">💾 Save Dish</button>
                <button class="btn btn-info" onclick="loadDish()">📂 Load Dish</button>
                <button class="btn btn-warning" onclick="clearAllData()">🗑️ Clear All Data</button>
            </div>
        </div>
    </div>
    
    <!-- Right Section: Cost Analysis -->
    <div class="plot-section" style="flex: 1;">
        <h3 class="points-title">Cost Analysis & Pricing</h3>
        
        <!-- Cost Breakdown -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Cost Breakdown</h4>
            <div id="cost-breakdown">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Ingredient Cost:</span>
                    <span id="ingredient-total">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Labor Cost:</span>
                    <span id="labor-total">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Overhead Cost:</span>
                    <span id="overhead-total">$0.00</span>
                </div>
                <hr style="margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
                    <span>Total Cost:</span>
                    <span id="total-cost">$0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Price vs Profit Margin Chart -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Price vs Profit Margin</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">See how the suggested price changes across different profit margins</p>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        
        <!-- Optimal Pricing Analysis -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Optimal Pricing Analysis</h4>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Based on your cost structure and sales data</p>
            <div id="optimal-pricing" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">OPTIMAL PRICE</div>
                    <div id="optimal-price" style="font-size: 24px; font-weight: bold; color: #28a745;">$0.00</div>
                </div>
                <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">PROFIT MARGIN</div>
                    <div id="optimal-profit-margin" style="font-size: 24px; font-weight: bold; color: #007bff;">0%</div>
                </div>
                <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">PROJECTED DAILY SALES</div>
                    <div id="optimal-units-sold" style="font-size: 24px; font-weight: bold; color: #dc3545;">0</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 6px; border-left: 4px solid #28a745;">
                <div style="font-weight: bold; color: #28a745; margin-bottom: 5px;">Projected Daily Profit at Optimal Price:</div>
                <div id="optimal-total-profit" style="font-size: 18px; font-weight: bold; color: #28a745;">$0.00</div>
            </div>
        </div>
        
        <!-- Pricing Calculator -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Alternate Pricing Calculator</h4>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <label style="min-width: 120px;">Desired Profit Margin (%):</label>
                <input type="number" id="profit-margin" value="30" min="0" max="100" onchange="updateAllCalculations()" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label style="min-width: 120px;">Suggested Price:</label>
                <span id="suggested-price" style="font-size: 18px; font-weight: bold; color: #28a745;">$0.00</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="min-width: 120px;">Actual Price ($):</label>
                <input type="number" id="actual-price" value="0.00" step="0.01" onchange="calculateActualProfit()" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <!-- Profit Analysis -->
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #333;">Profit Analysis</h4>
            <div id="profit-analysis">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Profit per Dish:</span>
                    <span id="profit-per-dish">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Actual Profit Margin:</span>
                    <span id="actual-profit-margin">0%</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Cost Percentage:</span>
                    <span id="cost-percentage">0%</span>
                </div>
            </div>
        </div>
        

        
        <div id="status-message" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
    </div>
</div>

<script>
    let ingredientCounter = 3; // Start with 3 ingredients
    let priceChart = null; // Global variable for the chart
    let salesDataCounter = 3; // Start with 3 sales data points
    let savedDishes = []; // Demo mode - dishes are only saved for current session
    
    // Create price vs profit margin chart
    function createPriceChart() {
        try {
            console.log('Creating price chart...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }
            
            const canvas = document.getElementById('priceChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            console.log('Canvas context obtained');
            
            // Destroy existing chart if it exists
            if (priceChart) {
                priceChart.destroy();
                console.log('Destroyed existing chart');
            }
            
            // Get total cost from the form
            const totalCost = parseFloat(document.getElementById('total-cost').textContent.replace('$', '')) || 0;
            console.log('Total cost:', totalCost);
            
            if (totalCost <= 0) {
                console.log('No cost data available, skipping chart');
                return;
            }
            
            // Generate price range with whole dollar amounts for axis labels
            const minPrice = Math.floor(totalCost); // Start at whole dollar amount at or below cost
            let maxPrice = Math.ceil(totalCost * 3); // Default: End at whole dollar amount at or above 300% of cost
            
            // Generate more data points for smooth hovering (every $0.25)
            const priceStep = 0.25; // Smaller intervals for smooth hovering
            let numPoints = Math.floor((maxPrice - minPrice) / priceStep) + 1; // More data points
            
            // Get sales data from the form inputs first
            const salesPrices = document.querySelectorAll('.sales-price');
            const salesQuantities = document.querySelectorAll('.sales-quantity');
            const actualSalesData = [];
            const actualSalesPrices = [];
            
            for (let i = 0; i < salesPrices.length; i++) {
                const price = parseFloat(salesPrices[i].value) || 0;
                const quantity = parseFloat(salesQuantities[i].value) || 0;
                if (price > 0 && quantity > 0) {
                    actualSalesData.push(quantity);
                    actualSalesPrices.push(price);
                }
            }
            
            // Create regression lines for both sales and profit data
            const extendedSalesData = [];
            const extendedProfitData = [];
            console.log('Sales data found:', actualSalesData.length, 'points');
            console.log('Prices:', actualSalesPrices);
            console.log('Quantities:', actualSalesData);
            
            // Calculate actual profit data from sales data
            const actualProfitData = [];
            for (let j = 0; j < actualSalesPrices.length; j++) {
                const actualPrice = actualSalesPrices[j];
                const actualQuantity = actualSalesData[j];
                const actualProfitPerUnit = actualPrice - totalCost;
                const actualTotalProfit = actualProfitPerUnit * actualQuantity;
                actualProfitData.push(actualTotalProfit);
            }
            console.log('Actual profit data:', actualProfitData);
            
            for (let i = 0; i < numPoints; i++) {
                const price = minPrice + (i * priceStep); // Smaller increments for smooth hovering
                let predictedSales;
                
                try {
                    if (actualSalesData.length >= 3) {
                        // 3+ data points - use exponential decay regression
                        predictedSales = fitExponentialDecay(price, actualSalesPrices, actualSalesData);
                    } else if (actualSalesData.length === 2) {
                        // 2 data points - use linear regression
                        predictedSales = fitLinearRegression(price, actualSalesPrices, actualSalesData);
                    } else if (actualSalesData.length === 1) {
                        // Single data point - no regression line, just use the data point
                        const referencePrice = actualSalesPrices[0];
                        const referenceSales = actualSalesData[0];
                        if (Math.abs(price - referencePrice) < 0.01) {
                            predictedSales = referenceSales; // Exact match
                        } else {
                            predictedSales = null; // No prediction for other prices
                        }
                    } else {
                        // No sales data - no regression line
                        predictedSales = null;
                    }
                } catch (error) {
                    console.error('Error calculating predicted sales:', error);
                    // Fallback to no prediction
                    predictedSales = null;
                }
                
                if (predictedSales !== null) {
                    extendedSalesData.push(predictedSales);
                } else {
                    extendedSalesData.push(0); // Use 0 for null values to maintain array length
                }
            }
            
            console.log('Extended sales data:', extendedSalesData);
            
            // If we have sales regression data, find where it hits 0 and adjust the chart range
            if (actualSalesData.length >= 2) {
                let salesZeroPrice = maxPrice; // Default to current max price
                
                if (actualSalesData.length >= 3) {
                    // For exponential decay, find where sales = 0
                    const maxSales = Math.max(...actualSalesData);
                    const minActualPrice = Math.min(...actualSalesPrices);
                    
                    // Find best decay rate first
                    let totalError = 0;
                    let bestDecayRate = 0.1;
                    for (let decayRate = 0.01; decayRate <= 1.0; decayRate += 0.01) {
                        let error = 0;
                        for (let j = 0; j < actualSalesPrices.length; j++) {
                            const expectedSales = maxSales * Math.exp(-decayRate * (actualSalesPrices[j] - minActualPrice));
                            error += Math.abs(expectedSales - actualSalesData[j]);
                        }
                        if (error < totalError || totalError === 0) {
                            totalError = error;
                            bestDecayRate = decayRate;
                        }
                    }
                    
                    // Find where sales = 0 (or very close to 0)
                    // Using 0.1 as threshold to avoid ln(0)
                    if (maxSales > 0.1) {
                        salesZeroPrice = minActualPrice - Math.log(0.1 / maxSales) / bestDecayRate;
                    }
                    
                } else if (actualSalesData.length === 2) {
                    // For linear regression, find where y = 0
                    const x1 = actualSalesPrices[0];
                    const y1 = actualSalesData[0];
                    const x2 = actualSalesPrices[1];
                    const y2 = actualSalesData[1];
                    
                    const slope = (y2 - y1) / (x2 - x1);
                    const intercept = y1 - slope * x1;
                    
                    // Find where y = 0: 0 = slope * x + intercept
                    // x = -intercept / slope
                    if (slope !== 0 && slope < 0) { // Only if slope is negative (sales decrease with price)
                        salesZeroPrice = -intercept / slope;
                    }
                }
                
                // Use the smaller of current max price or where sales hits 0
                const newMaxPrice = Math.min(maxPrice, Math.ceil(salesZeroPrice));
                if (newMaxPrice > minPrice) {
                    maxPrice = newMaxPrice;
                    numPoints = Math.floor((maxPrice - minPrice) / priceStep) + 1;
                    console.log(`Adjusted max price to $${maxPrice} where sales hits 0`);
                    
                    // Regenerate sales data with new price range
                    extendedSalesData.length = 0; // Clear the array
                    for (let i = 0; i < numPoints; i++) {
                        const price = minPrice + (i * priceStep);
                        let predictedSales;
                        
                        try {
                            if (actualSalesData.length >= 3) {
                                predictedSales = fitExponentialDecay(price, actualSalesPrices, actualSalesData);
                            } else if (actualSalesData.length === 2) {
                                predictedSales = fitLinearRegression(price, actualSalesPrices, actualSalesData);
                            } else {
                                predictedSales = null;
                            }
                        } catch (error) {
                            console.error('Error calculating predicted sales:', error);
                            predictedSales = null;
                        }
                        
                        if (predictedSales !== null) {
                            extendedSalesData.push(predictedSales);
                        } else {
                            extendedSalesData.push(0);
                        }
                    }
                }
            }
            
            const labels = [];
            const profitMargins = [];
            
            for (let i = 0; i < numPoints; i++) {
                const price = minPrice + (i * priceStep); // Smaller increments for smooth hovering
                
                // Calculate total profit with bowed-outwards curve
                const baseProfit = price - totalCost;
                if (baseProfit > 0) {
                    // Profit per unit (linear relationship)
                    const profitPerUnit = baseProfit;
                    
                    // Units sold (exponential decay from red line)
                    const unitsSold = extendedSalesData[i];
                    
                    // Total profit = profit per unit × units sold
                    // This creates a bowed-outwards curve because:
                    // - At low prices: high units sold but low profit per unit
                    // - At high prices: low units sold but high profit per unit
                    // - Optimal point is where the product is maximized
                    const totalProfit = profitPerUnit * unitsSold;
                    
                    profitMargins.push(totalProfit);
                } else {
                    // At or below cost - no profit
                    profitMargins.push(0);
                }
                
                labels.push(`$${price}`);
            }
            
            console.log('Generated data:', labels, profitMargins);
            console.log('Chart data validation:');
            console.log('- Labels length:', labels.length);
            console.log('- Profit margins length:', profitMargins.length);
            console.log('- Sales data length:', extendedSalesData.length);
            console.log('- Sample profit margins:', profitMargins.slice(0, 5));
            console.log('- Sample sales data:', extendedSalesData.slice(0, 5));
            
            // Find optimal price index for highlighting
            const maxProfitIndex = profitMargins.indexOf(Math.max(...profitMargins));
            
            // Create point radius array - only show point at optimal price
            const profitPointRadius = profitMargins.map((_, index) => index === maxProfitIndex ? 6 : 0);
            const salesPointRadius = extendedSalesData.map((_, index) => index === maxProfitIndex ? 6 : 0);
            
            // Create point color arrays - green for optimal profit point
            const profitPointColors = profitMargins.map((_, index) => index === maxProfitIndex ? '#28a745' : '#007bff');
            const salesPointColors = extendedSalesData.map((_, index) => index === maxProfitIndex ? '#dc3545' : '#dc3545');
            
            // Function to create array for actual sales data points
            function createActualSalesDataArray(labels, actualPrices, actualSales) {
                const dataArray = new Array(labels.length).fill(null);
                
                actualPrices.forEach((price, index) => {
                    // Find the exact or closest label index for this price
                    let labelIndex = labels.findIndex(label => {
                        const labelPrice = parseFloat(label.replace('$', ''));
                        return Math.abs(labelPrice - price) < 0.001; // Very small tolerance for exact match
                    });
                    
                    // If no exact match, find the closest one
                    if (labelIndex === -1) {
                        let minDiff = Infinity;
                        labels.forEach((label, i) => {
                            const labelPrice = parseFloat(label.replace('$', ''));
                            const diff = Math.abs(labelPrice - price);
                            if (diff < minDiff) {
                                minDiff = diff;
                                labelIndex = i;
                            }
                        });
                    }
                    
                    if (labelIndex !== -1) {
                        dataArray[labelIndex] = actualSales[index];
                    }
                });
                
                return dataArray;
            }
            
            // Function to fit exponential decay to actual data points
            function fitExponentialDecay(price, actualPrices, actualSales) {
                // Sort data points by price
                const sortedData = actualPrices.map((p, i) => ({ price: p, sales: actualSales[i] }))
                    .sort((a, b) => a.price - b.price);
                
                // Find the maximum sales and minimum price as reference points
                const maxSales = Math.max(...actualSales);
                const minPrice = Math.min(...actualPrices);
                
                // Calculate exponential decay parameters by fitting to actual data
                let totalError = 0;
                let bestDecayRate = 0.1; // Start with a reasonable decay rate
                
                // Try different decay rates to find the best fit to actual data
                for (let decayRate = 0.01; decayRate <= 1.0; decayRate += 0.01) {
                    let error = 0;
                    for (let j = 0; j < actualPrices.length; j++) {
                        const expectedSales = maxSales * Math.exp(-decayRate * (actualPrices[j] - minPrice));
                        error += Math.abs(expectedSales - actualSales[j]);
                    }
                    if (error < totalError || totalError === 0) {
                        totalError = error;
                        bestDecayRate = decayRate;
                    }
                }
                
                // Use the fitted exponential decay to predict sales
                const predictedSales = maxSales * Math.exp(-bestDecayRate * (price - minPrice));
                console.log(`Price $${price.toFixed(2)}: Predicted sales = ${predictedSales.toFixed(1)} (decay rate: ${bestDecayRate.toFixed(3)})`);
                
                return Math.max(0, predictedSales);
            }
            
            // Function to fit linear regression to 2 data points
            function fitLinearRegression(price, actualPrices, actualSales) {
                // For 2 points, calculate the slope and intercept
                const x1 = actualPrices[0];
                const y1 = actualSales[0];
                const x2 = actualPrices[1];
                const y2 = actualSales[1];
                
                // Calculate slope (m) and intercept (b) for y = mx + b
                const slope = (y2 - y1) / (x2 - x1);
                const intercept = y1 - slope * x1;
                
                // Predict sales using linear equation
                const predictedSales = slope * price + intercept;
                console.log(`Price $${price.toFixed(2)}: Predicted sales = ${predictedSales.toFixed(1)} (linear: y = ${slope.toFixed(3)}x + ${intercept.toFixed(3)})`);
                
                return Math.max(0, predictedSales);
            }
            
            // Create datasets with points on the lines
            const profitDataset = {
                label: 'Profit($)',
                data: profitMargins,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.1,
                pointRadius: profitPointRadius,
                pointHoverRadius: 6,
                pointBackgroundColor: profitPointColors,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointStyle: 'circle',
                pointHitRadius: 10,
                yAxisID: 'y'
            };
            
            const salesDataset = {
                label: 'Projected Daily Sales',
                data: extendedSalesData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                pointRadius: salesPointRadius,
                pointHoverRadius: 6,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointStyle: 'circle',
                pointHitRadius: 10,
                yAxisID: 'y1'
            };
            
            // Create dataset for actual sales data points
            const actualSalesDataset = {
                label: 'Actual Sales Data',
                data: createActualSalesDataArray(labels, actualSalesPrices, actualSalesData),
                borderColor: '#ffc107',
                backgroundColor: '#ffc107',
                borderWidth: 0,
                fill: false,
                tension: 0,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: '#ffc107',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointStyle: 'circle',
                pointHitRadius: 10,
                yAxisID: 'y1'
            };
            
            // Prepare datasets array - always include profit dataset
            const datasets = [profitDataset];
            
            // Only add sales regression line if there are 2 or more actual sales data points
            if (actualSalesData.length >= 2) {
                datasets.push(salesDataset);
            }
            
            // Always add actual sales data points if they exist
            if (actualSalesData.length > 0) {
                datasets.push(actualSalesDataset);
            }
            
            // Create chart with just the lines (no points)
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Profit($)') {
                                        return `Total Profit: $${context.parsed.y.toFixed(2)}`;
                                    } else if (context.dataset.label === 'Projected Daily Sales') {
                                        return `Projected Daily Sales: ${context.parsed.y.toFixed(2)}`;
                                    } else if (context.dataset.label === 'Actual Sales Data') {
                                        // Get the actual price from the data array
                                        const actualSalesDataArray = createActualSalesDataArray(labels, actualSalesPrices, actualSalesData);
                                        const dataIndex = context.dataIndex;
                                        // Find which actual sales data point this corresponds to
                                        for (let i = 0; i < actualSalesPrices.length; i++) {
                                            if (actualSalesDataArray[dataIndex] === actualSalesData[i]) {
                                                return `Actual Sales: ${context.parsed.y.toFixed(2)} units at $${actualSalesPrices[i].toFixed(2)}`;
                                            }
                                        }
                                        return `Actual Sales: ${context.parsed.y.toFixed(2)} units`;
                                    }
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Price ($)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const price = parseFloat(this.getLabelForValue(value).replace('$', ''));
                                    // Only show label if price is a whole dollar amount
                                    if (Math.abs(price - Math.round(price)) < 0.01) {
                                        return '$' + Math.round(price);
                                    }
                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Total Profit ($)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            max: Math.max(...profitMargins) * 1.1,
                            ticks: {
                                callback: function(value) {
                                    return '$' + Math.round(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: actualSalesData.length >= 2, // Only show if there are 2+ sales data points
                            position: 'right',
                            title: {
                                display: actualSalesData.length >= 2, // Only show if there are 2+ sales data points
                                text: 'Projected Daily Sales',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            max: actualSalesData.length >= 2 ? Math.max(...extendedSalesData) * 1.1 : 0,
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value);
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log('Chart created successfully');
            console.log('Chart instance:', priceChart);
            
            // Calculate and display optimal pricing
            calculateOptimalPricing(profitMargins, labels, extendedSalesData, totalCost);
            
        } catch (error) {
            console.error('Error creating chart:', error);
        }
    }
    
    // Calculate optimal pricing based on chart data
    function calculateOptimalPricing(profitMargins, labels, salesData, totalCost) {
        try {
            // Find the maximum profit point
            const maxProfitIndex = profitMargins.indexOf(Math.max(...profitMargins));
            const optimalPrice = parseFloat(labels[maxProfitIndex].replace('$', ''));
            const optimalTotalProfit = profitMargins[maxProfitIndex];
            const optimalUnitsSold = salesData[maxProfitIndex];
            
            // Calculate profit margin percentage
            const optimalProfitMargin = ((optimalPrice - totalCost) / optimalPrice) * 100;
            
            // Update the display
            document.getElementById('optimal-price').textContent = `$${optimalPrice.toFixed(2)}`;
            document.getElementById('optimal-profit-margin').textContent = `${optimalProfitMargin.toFixed(2)}%`;
            document.getElementById('optimal-units-sold').textContent = Math.round(optimalUnitsSold);
            document.getElementById('optimal-total-profit').textContent = `$${optimalTotalProfit.toFixed(2)}`;
            
            console.log('Optimal pricing calculated:', {
                price: optimalPrice,
                profitMargin: optimalProfitMargin,
                unitsSold: optimalUnitsSold,
                totalProfit: optimalTotalProfit
            });
            
        } catch (error) {
            console.error('Error calculating optimal pricing:', error);
        }
    }
    
    // Save current dish to localStorage
    function saveDish() {
        const dishName = document.getElementById('dish-name').value.trim();
        if (!dishName) {
            alert('Please enter a dish name before saving.');
            return;
        }
        
        // Check if dish name already exists
        const existingIndex = savedDishes.findIndex(dish => dish.name === dishName);
        if (existingIndex !== -1) {
            // Show overwrite confirmation modal
            showOverwriteModal(dishName, existingIndex);
            return;
        }
        
        // Save the dish directly
        saveDishData(dishName);
    }
    
    // Show overwrite confirmation modal
    function showOverwriteModal(dishName, existingIndex) {
        const modalHTML = `
            <div id="overwriteModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            ">
                <div style="
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 400px;
                    width: 90%;
                ">
                    <h3 style="margin-top: 0; color: #333;">Dish Already Exists</h3>
                    <p style="color: #666; margin: 20px 0;">A dish named "<strong>${dishName}</strong>" already exists. Do you want to overwrite it?</p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                        <button onclick="overwriteDish('${dishName}', ${existingIndex})" style="
                            padding: 10px 20px;
                            background-color: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Overwrite</button>
                        <button onclick="closeOverwriteModal()" style="
                            padding: 10px 20px;
                            background-color: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Close overwrite modal
    function closeOverwriteModal() {
        const modal = document.getElementById('overwriteModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // Overwrite existing dish
    function overwriteDish(dishName, existingIndex) {
        savedDishes.splice(existingIndex, 1);
        closeOverwriteModal();
        saveDishData(dishName);
    }
    
    // Save dish data (common function for both new and overwrite)
    function saveDishData(dishName) {
        
        // Collect all ingredient data
        const ingredients = [];
        const ingredientRows = document.querySelectorAll('.ingredient-row');
        ingredientRows.forEach(row => {
            const name = row.querySelector('.ingredient-name').value;
            const cost = parseFloat(row.querySelector('.ingredient-cost').value) || 0;
            const amount = parseFloat(row.querySelector('.ingredient-amount').value) || 0;
            const unit = row.querySelector('.ingredient-unit').value;
            
            if (name.trim()) {
                ingredients.push({ name, cost, amount, unit });
            }
        });
        
        // Collect sales data
        const salesData = [];
        const salesRows = document.querySelectorAll('.sales-row');
        salesRows.forEach(row => {
            const price = parseFloat(row.querySelector('.sales-price').value) || 0;
            const quantity = parseFloat(row.querySelector('.sales-quantity').value) || 0;
            
            if (price > 0 && quantity > 0) {
                salesData.push({ price, quantity });
            }
        });
        
        // Create dish object
        const dish = {
            name: dishName,
            ingredients: ingredients,
            laborCost: parseFloat(document.getElementById('labor-cost').value) || 0,
            overheadCost: parseFloat(document.getElementById('overhead-cost').value) || 0,
            salesData: salesData,
            timestamp: new Date().toISOString()
        };
        
        // Save to session memory (demo mode)
        savedDishes.push(dish);
        
        // Show success modal
        showSaveSuccessModal(dishName);
        console.log('Saved dish:', dish);
    }
    
    // Show save success modal
    function showSaveSuccessModal(dishName) {
        const modalHTML = `
            <div id="saveSuccessModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            ">
                <div style="
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <div style="
                        width: 60px;
                        height: 60px;
                        background-color: #28a745;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 20px;
                        font-size: 30px;
                        color: white;
                    ">✓</div>
                    <h3 style="margin-top: 0; color: #333;">Dish Saved Successfully!</h3>
                    <p style="color: #666; margin: 20px 0;">"<strong>${dishName}</strong>" has been saved to your dish library.</p>
                    <button onclick="closeSaveSuccessModal()" style="
                        padding: 10px 25px;
                        background-color: #28a745;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 16px;
                    ">OK</button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Close save success modal
    function closeSaveSuccessModal() {
        const modal = document.getElementById('saveSuccessModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // Clear all form data
    function clearAllData() {
        // Show confirmation prompt
        if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
            return; // User cancelled
        }
        
        // Clear dish name
        document.getElementById('dish-name').value = '';
        
        // Clear all ingredient rows except the first one
        const ingredientRows = document.querySelectorAll('.ingredient-row');
        for (let i = 1; i < ingredientRows.length; i++) {
            ingredientRows[i].remove();
        }
        
        // Clear the first ingredient row
        if (ingredientRows.length > 0) {
            const firstRow = ingredientRows[0];
            firstRow.querySelector('.ingredient-name').value = '';
            firstRow.querySelector('.ingredient-cost').value = '0';
            firstRow.querySelector('.ingredient-amount').value = '0';
            firstRow.querySelector('.ingredient-unit').value = 'g';
            
            // Trigger onchange events
            firstRow.querySelector('.ingredient-cost').dispatchEvent(new Event('change'));
            firstRow.querySelector('.ingredient-amount').dispatchEvent(new Event('change'));
            firstRow.querySelector('.ingredient-unit').dispatchEvent(new Event('change'));
        }
        
        // Clear all sales data rows except the first one
        const salesRows = document.querySelectorAll('.sales-row');
        for (let i = 1; i < salesRows.length; i++) {
            salesRows[i].remove();
        }
        
        // Clear the first sales row
        if (salesRows.length > 0) {
            const firstRow = salesRows[0];
            firstRow.querySelector('.sales-price').value = '0';
            firstRow.querySelector('.sales-quantity').value = '0';
            
            // Trigger onchange events
            firstRow.querySelector('.sales-price').dispatchEvent(new Event('change'));
            firstRow.querySelector('.sales-quantity').dispatchEvent(new Event('change'));
        }
        
        // Clear labor and overhead costs
        document.getElementById('labor-cost').value = '0';
        document.getElementById('overhead-cost').value = '0';
        
        // Trigger onchange events
        document.getElementById('labor-cost').dispatchEvent(new Event('change'));
        document.getElementById('overhead-cost').dispatchEvent(new Event('change'));
        
        // Clear cost breakdown form data
        document.getElementById('cost-breakdown-price').value = '0';
        document.getElementById('cost-breakdown-quantity').value = '0';
        
        // Clear alternate pricing calculator form data
        document.getElementById('alternate-price').value = '0';
        document.getElementById('alternate-quantity').value = '0';
        
        // Clear the chart if it exists
        if (priceChart) {
            priceChart.destroy();
            priceChart = null;
        }
        
        // Clear the canvas
        const canvas = document.getElementById('priceChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Clear optimal pricing display
        document.getElementById('optimal-price').textContent = '$0.00';
        document.getElementById('optimal-profit-margin').textContent = '0.00%';
        document.getElementById('optimal-units-sold').textContent = '0';
        document.getElementById('optimal-total-profit').textContent = '$0.00';
        
        console.log('All form data cleared');
    }
    
    // Load dish from saved dishes
    function loadDish() {
        if (savedDishes.length === 0) {
            alert('No saved dishes found.');
            return;
        }
        
        // Create and show modal
        showDishSelectionModal();
    }
    
    // Show dish selection modal
    function showDishSelectionModal() {
        // Create modal HTML
        const modalHTML = `
            <div id="dishModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            ">
                <div style="
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <h3 style="margin-top: 0; color: #333;">Select a Dish to Load</h3>
                    <div id="dishList" style="margin: 20px 0;">
                        ${savedDishes.map((dish, index) => `
                            <div class="dish-option" data-index="${index}" style="
                                padding: 15px;
                                margin: 10px 0;
                                border: 2px solid #dee2e6;
                                border-radius: 6px;
                                cursor: pointer;
                                transition: all 0.2s;
                                background-color: #f8f9fa;
                            " onmouseover="this.style.borderColor='#007bff'; this.style.backgroundColor='#e3f2fd';" 
                               onmouseout="this.style.borderColor='#dee2e6'; this.style.backgroundColor='#f8f9fa';"
                               onclick="selectDish(${index})">
                                <div style="font-weight: bold; color: #333;">${dish.name}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ${dish.ingredients.length} ingredients • Saved ${new Date(dish.timestamp).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeDishModal()" style="
                            padding: 10px 20px;
                            background-color: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Close dish selection modal
    function closeDishModal() {
        const modal = document.getElementById('dishModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // Select dish from modal
    function selectDish(index) {
        if (index < 0 || index >= savedDishes.length) {
            alert('Invalid selection.');
            return;
        }
        
        const selectedDish = savedDishes[index];
        
        // Close the modal
        closeDishModal();
        
        // Load dish data
        document.getElementById('dish-name').value = selectedDish.name;
        document.getElementById('labor-cost').value = selectedDish.laborCost;
        document.getElementById('overhead-cost').value = selectedDish.overheadCost;
        
        // Load ingredients
        const ingredientsContainer = document.getElementById('ingredients-container');
        ingredientsContainer.innerHTML = '';
        
        selectedDish.ingredients.forEach((ingredient, index) => {
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row';
            ingredientRow.setAttribute('data-index', index);
            ingredientRow.innerHTML = `
                <span class="ingredient-label">Ingredient ${index + 1}:</span>
                <div class="ingredient-fields">
                    <div class="ingredient-field">
                        <label>Name</label>
                        <input type="text" class="ingredient-name" placeholder="Ingredient Name" value="${ingredient.name}" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Cost ($)</label>
                        <input type="number" class="ingredient-cost" placeholder="Cost ($)" value="${ingredient.cost}" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Amount</label>
                        <input type="number" class="ingredient-amount" placeholder="Amount" value="${ingredient.amount}" step="0.01" onchange="updateAllCalculations()">
                    </div>
                    <div class="ingredient-field">
                        <label>Unit</label>
                        <select class="ingredient-unit" onchange="updateAllCalculations()">
                            <option value="lbs" ${ingredient.unit === 'lbs' ? 'selected' : ''}>lbs</option>
                            <option value="oz" ${ingredient.unit === 'oz' ? 'selected' : ''}>oz</option>
                            <option value="g" ${ingredient.unit === 'g' ? 'selected' : ''}>g</option>
                            <option value="cups" ${ingredient.unit === 'cups' ? 'selected' : ''}>cups</option>
                            <option value="tbsp" ${ingredient.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                            <option value="tsp" ${ingredient.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                            <option value="each" ${ingredient.unit === 'each' ? 'selected' : ''}>each</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeIngredient(${index})" style="margin-left: 5px; align-self: flex-end;">×</button>
                </div>
            `;
            ingredientsContainer.appendChild(ingredientRow);
        });
        
        // Load sales data
        const salesContainer = document.getElementById('sales-data-container');
        salesContainer.innerHTML = '';
        
        selectedDish.salesData.forEach((sale, index) => {
            const salesRow = document.createElement('div');
            salesRow.className = 'sales-row';
            salesRow.setAttribute('data-index', index);
            salesRow.innerHTML = `
                <span class="sales-label">Price Point ${index + 1}:</span>
                <div class="sales-fields">
                    <div class="sales-field">
                        <label>Price ($)</label>
                        <input type="number" class="sales-price" placeholder="Price" value="${sale.price}" step="0.01" onchange="updateSalesChart()">
                    </div>
                    <div class="sales-field">
                        <label>Sales</label>
                        <input type="number" class="sales-quantity" placeholder="Quantity" value="${sale.quantity}" step="1" onchange="updateSalesChart()">
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeSalesData(${index})" style="margin-left: 5px; align-self: flex-end;">×</button>
                </div>
            `;
            salesContainer.appendChild(salesRow);
        });
        
        // Update counters
        ingredientCounter = selectedDish.ingredients.length;
        salesDataCounter = selectedDish.salesData.length;
        
        // Update all calculations
        updateAllCalculations();
        
        alert(`Dish "${selectedDish.name}" loaded successfully!`);
        console.log('Loaded dish:', selectedDish);
    }
    
    // Get sales data from inputs
    function getSalesData() {
        const salesPrices = document.querySelectorAll('.sales-price');
        const salesQuantities = document.querySelectorAll('.sales-quantity');
        const salesData = [];
        
        for (let i = 0; i < salesPrices.length; i++) {
            const price = parseFloat(salesPrices[i].value) || 0;
            const quantity = parseFloat(salesQuantities[i].value) || 0;
            if (price > 0 && quantity > 0) {
                salesData.push({ price: price, quantity: quantity });
            }
        }
        
        return salesData.sort((a, b) => a.price - b.price);
    }
    
    // Update sales chart
    function updateSalesChart() {
        createPriceChart(); // Update the price chart to refresh the dual X-axis
    }
    
    // Add new sales data point
    function addSalesData() {
        salesDataCounter++;
        const container = document.getElementById('sales-data-container');
        const currentIndex = container.children.length;
        const newSalesData = document.createElement('div');
        newSalesData.className = 'sales-row';
        newSalesData.setAttribute('data-index', currentIndex);
        newSalesData.innerHTML = `
            <span class="sales-label">Price Point ${salesDataCounter}:</span>
            <div class="sales-fields">
                <div class="sales-field">
                    <label>Price ($)</label>
                    <input type="number" class="sales-price" placeholder="Price" step="0.01" onchange="updateSalesChart()">
                </div>
                <div class="sales-field">
                    <label>Sales</label>
                    <input type="number" class="sales-quantity" placeholder="Quantity" step="1" onchange="updateSalesChart()">
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeSalesData(${currentIndex})" style="margin-left: 5px; align-self: flex-end;">×</button>
            </div>
        `;
        container.appendChild(newSalesData);
        updateSalesChart();
    }
    
    // Remove specific sales data point
    function removeSalesData(index) {
        const container = document.getElementById('sales-data-container');
        const salesRows = container.getElementsByClassName('sales-row');
        
        if (salesRows.length > 1) { // Keep at least one data point
            // Remove the specific data point
            container.removeChild(salesRows[index]);
            salesDataCounter--;
            
            // Update indices and labels for remaining data points
            const remainingRows = container.getElementsByClassName('sales-row');
            for (let i = 0; i < remainingRows.length; i++) {
                const salesRow = remainingRows[i];
                salesRow.setAttribute('data-index', i);
                salesRow.querySelector('.sales-label').textContent = `Price Point ${i + 1}:`;
                salesRow.querySelector('.btn-danger').setAttribute('onclick', `removeSalesData(${i})`);
            }
            
            updateSalesChart();
        } else {
            alert('You must keep at least one sales data point!');
        }
    }
    
    // Calculate total cost
    function calculateTotal() {
        let ingredientTotal = 0;
        const ingredientCosts = document.querySelectorAll('.ingredient-cost');
        const ingredientAmounts = document.querySelectorAll('.ingredient-amount');
        
        console.log('Calculating total cost...');
        console.log('Found', ingredientCosts.length, 'ingredient cost inputs');
        
        // Check if all form fields are empty
        let allFieldsEmpty = true;
        
        // Check ingredient fields
        for (let i = 0; i < ingredientCosts.length; i++) {
            const cost = parseFloat(ingredientCosts[i].value) || 0;
            const amount = parseFloat(ingredientAmounts[i].value) || 0;
            if (cost > 0 || amount > 0) {
                allFieldsEmpty = false;
            }
            ingredientTotal += cost * amount;
            console.log(`Ingredient ${i + 1}: cost=${cost}, amount=${amount}, subtotal=${cost * amount}`);
        }
        
        const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
        const overheadCost = parseFloat(document.getElementById('overhead-cost').value) || 0;
        
        // Check if labor or overhead costs are set
        if (laborCost > 0 || overheadCost > 0) {
            allFieldsEmpty = false;
        }
        
        // Check sales data fields
        const salesPrices = document.querySelectorAll('.sales-price');
        const salesQuantities = document.querySelectorAll('.sales-quantity');
        for (let i = 0; i < salesPrices.length; i++) {
            const price = parseFloat(salesPrices[i].value) || 0;
            const quantity = parseFloat(salesQuantities[i].value) || 0;
            if (price > 0 || quantity > 0) {
                allFieldsEmpty = false;
            }
        }
        
        // If all fields are empty, set everything to 0
        if (allFieldsEmpty) {
            document.getElementById('ingredient-total').textContent = '$0.00';
            document.getElementById('labor-total').textContent = '$0.00';
            document.getElementById('overhead-total').textContent = '$0.00';
            document.getElementById('total-cost').textContent = '$0.00';
            document.getElementById('suggested-price').textContent = '$0.00';
            document.getElementById('profit-per-dish').textContent = '$0.00';
            document.getElementById('actual-profit-margin').textContent = '0%';
            document.getElementById('cost-percentage').textContent = '0%';
            document.getElementById('optimal-price').textContent = '$0.00';
            document.getElementById('optimal-profit-margin').textContent = '0.00%';
            document.getElementById('optimal-units-sold').textContent = '0';
            document.getElementById('optimal-total-profit').textContent = '$0.00';
            return 0;
        }
        
        const totalCost = ingredientTotal + laborCost + overheadCost;
        
        console.log('Cost breakdown:', {
            ingredientTotal: ingredientTotal,
            laborCost: laborCost,
            overheadCost: overheadCost,
            totalCost: totalCost
        });
        
        // Update display
        document.getElementById('ingredient-total').textContent = `$${ingredientTotal.toFixed(2)}`;
        document.getElementById('labor-total').textContent = `$${laborCost.toFixed(2)}`;
        document.getElementById('overhead-total').textContent = `$${overheadCost.toFixed(2)}`;
        document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
        
        return totalCost;
    }
    
    // Calculate suggested price based on profit margin
    function calculatePrice() {
        const totalCost = parseFloat(document.getElementById('total-cost').textContent.replace('$', '')) || 0;
        const profitMargin = parseFloat(document.getElementById('profit-margin').value) || 0;
        
        if (profitMargin >= 100) {
            document.getElementById('suggested-price').textContent = 'Invalid margin';
            return;
        }
        
        const suggestedPrice = totalCost / (1 - profitMargin / 100);
        document.getElementById('suggested-price').textContent = `$${suggestedPrice.toFixed(2)}`;
        
        // Update actual price if it's 0
        const actualPrice = document.getElementById('actual-price');
        if (parseFloat(actualPrice.value) === 0) {
            actualPrice.value = suggestedPrice.toFixed(2);
            calculateActualProfit();
        }
    }
    
    // Calculate actual profit based on set price
    function calculateActualProfit() {
        const totalCost = parseFloat(document.getElementById('total-cost').textContent.replace('$', '')) || 0;
        const actualPrice = parseFloat(document.getElementById('actual-price').value) || 0;
        
        if (actualPrice === 0) {
            document.getElementById('profit-per-dish').textContent = '$0.00';
            document.getElementById('actual-profit-margin').textContent = '0%';
            document.getElementById('cost-percentage').textContent = '0%';
            return;
        }
        
        const profitPerDish = actualPrice - totalCost;
        const actualProfitMargin = (profitPerDish / actualPrice) * 100;
        const costPercentage = (totalCost / actualPrice) * 100;
        
        document.getElementById('profit-per-dish').textContent = `$${profitPerDish.toFixed(2)}`;
        document.getElementById('actual-profit-margin').textContent = `${actualProfitMargin.toFixed(2)}%`;
        document.getElementById('cost-percentage').textContent = `${costPercentage.toFixed(2)}%`;
        
        // Color coding for profit margin
        const profitMarginElement = document.getElementById('actual-profit-margin');
        if (actualProfitMargin >= 30) {
            profitMarginElement.style.color = '#28a745'; // Green for good margin
        } else if (actualProfitMargin >= 15) {
            profitMarginElement.style.color = '#ffc107'; // Yellow for moderate margin
        } else {
            profitMarginElement.style.color = '#dc3545'; // Red for low margin
        }
    }
    
    // Add new ingredient
    function addIngredient() {
        ingredientCounter++;
        const container = document.getElementById('ingredients-container');
        const currentIndex = container.children.length;
        const newIngredient = document.createElement('div');
        newIngredient.className = 'ingredient-row';
        newIngredient.setAttribute('data-index', currentIndex);
        newIngredient.innerHTML = `
            <span class="ingredient-label">Ingredient ${ingredientCounter}:</span>
            <div class="ingredient-fields">
                <div class="ingredient-field">
                    <label>Name</label>
                    <input type="text" class="ingredient-name" placeholder="Ingredient Name" onchange="calculateTotal()">
                </div>
                <div class="ingredient-field">
                    <label>Cost ($)</label>
                    <input type="number" class="ingredient-cost" placeholder="Cost ($)" step="0.01" onchange="calculateTotal()">
                </div>
                <div class="ingredient-field">
                    <label>Amount</label>
                    <input type="number" class="ingredient-amount" placeholder="Amount" step="0.01" onchange="calculateTotal()">
                </div>
                <div class="ingredient-field">
                    <label>Unit</label>
                    <select class="ingredient-unit" onchange="calculateTotal()">
                        <option value="lbs">lbs</option>
                        <option value="oz">oz</option>
                        <option value="g">g</option>
                        <option value="cups">cups</option>
                        <option value="tbsp">tbsp</option>
                        <option value="tsp">tsp</option>
                        <option value="each">each</option>
                    </select>
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeIngredient(${currentIndex})" style="margin-left: 5px; align-self: flex-end;">×</button>
            </div>
        `;
        container.appendChild(newIngredient);
        updateAllCalculations();
    }
    
    // Remove specific ingredient
    function removeIngredient(index) {
        const container = document.getElementById('ingredients-container');
        const ingredients = container.getElementsByClassName('ingredient-row');
        
        if (ingredients.length > 1) { // Keep at least one ingredient
            // Remove the specific ingredient
            container.removeChild(ingredients[index]);
            ingredientCounter--;
            
            // Update indices and labels for remaining ingredients
            const remainingIngredients = container.getElementsByClassName('ingredient-row');
            for (let i = 0; i < remainingIngredients.length; i++) {
                const ingredientRow = remainingIngredients[i];
                ingredientRow.setAttribute('data-index', i);
                ingredientRow.querySelector('.ingredient-label').textContent = `Ingredient ${i + 1}:`;
                ingredientRow.querySelector('.btn-danger').setAttribute('onclick', `removeIngredient(${i})`);
            }
            
            updateAllCalculations();
        } else {
            alert('You must keep at least one ingredient!');
        }
    }
    
    // Update all calculations
    function updateAllCalculations() {
        calculateTotal();
        calculatePrice();
        calculateActualProfit();
        createPriceChart();
    }
    
    // Check if Chart.js is loaded
    function waitForChartJS(callback, maxAttempts = 10) {
        let attempts = 0;
        
        function checkChartJS() {
            attempts++;
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js loaded successfully');
                callback();
            } else if (attempts < maxAttempts) {
                console.log(`Chart.js not loaded yet, attempt ${attempts}/${maxAttempts}`);
                setTimeout(checkChartJS, 300);
            } else {
                console.error('Chart.js failed to load after multiple attempts');
                // Still run the calculator without the chart
                calculateTotal();
                calculatePrice();
                calculateActualProfit();
            }
        }
        
        checkChartJS();
    }
    
    // Load default example data
    function loadDefaultExampleData() {
        // Reset dish name
        document.getElementById('dish-name').value = 'Beef Stir-Fry';
        
        // Reset ingredient data
        const ingredientRows = document.querySelectorAll('.ingredient-row');
        
        // Clear all ingredient rows except the first one
        for (let i = 1; i < ingredientRows.length; i++) {
            ingredientRows[i].remove();
        }
        
        // Set first ingredient data
        if (ingredientRows.length > 0) {
            const firstRow = ingredientRows[0];
            firstRow.querySelector('.ingredient-name').value = 'Beef';
            firstRow.querySelector('.ingredient-cost').value = '15.99';
            firstRow.querySelector('.ingredient-amount').value = '0.4';
            firstRow.querySelector('.ingredient-unit').value = 'lbs';
        }
        
        // Add second ingredient
        addIngredient();
        const secondRow = document.querySelectorAll('.ingredient-row')[1];
        if (secondRow) {
            secondRow.querySelector('.ingredient-name').value = 'Noodles';
            secondRow.querySelector('.ingredient-cost').value = '2.49';
            secondRow.querySelector('.ingredient-amount').value = '0.3';
            secondRow.querySelector('.ingredient-unit').value = 'lbs';
        }
        
        // Add third ingredient
        addIngredient();
        const thirdRow = document.querySelectorAll('.ingredient-row')[2];
        if (thirdRow) {
            thirdRow.querySelector('.ingredient-name').value = 'Vegetables';
            thirdRow.querySelector('.ingredient-cost').value = '3.99';
            thirdRow.querySelector('.ingredient-amount').value = '0.2';
            thirdRow.querySelector('.ingredient-unit').value = 'lbs';
        }
        
        // Reset labor and overhead costs
        document.getElementById('labor-cost').value = '4.25';
        document.getElementById('overhead-cost').value = '2.15';
        
        // Reset sales data
        const salesRows = document.querySelectorAll('.sales-row');
        
        // Clear all sales rows except the first one
        for (let i = 1; i < salesRows.length; i++) {
            salesRows[i].remove();
        }
        
        // Set first sales data
        if (salesRows.length > 0) {
            const firstRow = salesRows[0];
            firstRow.querySelector('.sales-price').value = '14.00';
            firstRow.querySelector('.sales-quantity').value = '28';
        }
        
        // Add second sales data
        addSalesData();
        const secondSalesRow = document.querySelectorAll('.sales-row')[1];
        if (secondSalesRow) {
            secondSalesRow.querySelector('.sales-price').value = '16.00';
            secondSalesRow.querySelector('.sales-quantity').value = '22';
        }
        
        // Add third sales data
        addSalesData();
        const thirdSalesRow = document.querySelectorAll('.sales-row')[2];
        if (thirdSalesRow) {
            thirdSalesRow.querySelector('.sales-price').value = '18.00';
            thirdSalesRow.querySelector('.sales-quantity').value = '15';
        }
        
        // Reset counters
        ingredientCounter = 3;
        salesDataCounter = 3;
        
        console.log('Default example data loaded');
    }
    
    // Initialize the calculator when the page loads
    window.onload = function() {
        // Load default example data
        loadDefaultExampleData();
        
        // Run basic calculations immediately
        calculateTotal();
        calculatePrice();
        calculateActualProfit();
        
        // Then wait for Chart.js and create the chart
        waitForChartJS(function() {
            createPriceChart();
        });
    };
</script>

<style>
    .ingredient-row {
        margin-bottom: 18px;
    }
    .ingredient-fields {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-top: 4px;
    }
    .ingredient-field {
        display: flex;
        flex-direction: column;
        min-width: 90px;
    }
    .ingredient-label {
        min-width: 100px;
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
    }
    .ingredient-name {
        width: 120px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .ingredient-cost, .ingredient-amount {
        width: 80px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .ingredient-unit {
        width: 70px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    #cost-breakdown div, #profit-analysis div {
        padding: 3px 0;
    }
    hr {
        border: none;
        border-top: 1px solid #dee2e6;
    }
    #priceChart, #optimalPriceChart {
        height: 300px !important;
        width: 100% !important;
        max-width: 100%;
        display: block;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
    }
    
    #priceChart {
        background-color: white;
        border: 1px solid #ccc;
    }
    
    .sales-row {
        margin-bottom: 18px;
    }
    .sales-fields {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-top: 4px;
    }
    .sales-field {
        display: flex;
        flex-direction: column;
        min-width: 90px;
    }
    .sales-label {
        min-width: 100px;
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
    }
    .sales-price, .sales-quantity {
        width: 80px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>
{% endblock %} 